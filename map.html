<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />

  <!-- MAPBOX -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      overflow: hidden;
    }

    #map {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 700px;
      background: #eee;
    }

    /* Marker simple */
    .marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color);
      border: 3px solid white;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      cursor: pointer;
    }

    .mapboxgl-popup {
      max-width: 280px !important;
    }

    .mapboxgl-popup-content {
      padding: 0;
      border-radius: 18px;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }

    .popup-card {
      background: white;
    }

    .popup-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
    }

    .popup-body {
      padding: 14px 16px 16px;
    }

    .popup-title {
      font-size: 18px;
      font-weight: 600;
      color: #2f2cd6;
      margin-bottom: 8px;
    }

    .popup-address {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 13px;
      color: #555;
      margin-bottom: 10px;
    }

    .popup-address span {
      line-height: 1.3;
    }

    .popup-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .popup-status {
      background: #2f2cd6;
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .popup-pin {
      width: 36px;
      height: 36px;
      background: #2f2cd6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-separator {
      height: 1px;
      background: #ececec;
      margin: 8px 0 10px;
    }

    .popup-coloc {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    .popup-coloc span {
      line-height: 1.3;
    }

    .popup-link-wrapper {
      display: block;
      cursor: pointer;
      text-decoration: none !important;
      color: inherit !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    console.log("üìç map.html loaded");

    mapboxgl.accessToken =
      "pk.eyJ1IjoicHRpdGtpd2kiLCJhIjoiY21pZG9uZGkwMDZ4MzJpcXZ0dnVoM2YwNSJ9.AbdFkhkiESdeKA7XNTUQNQ";

    let map = null;
    let markersById = {};
    let openPopup = null;

    // -----------------------------
    // RAYON √Ä PARTIR DES BOUNDS
    // -----------------------------
    function computeRadiusFromBounds(minLat, minLng, maxLat, maxLng) {
      const centerLat = (minLat + maxLat) / 2;
      const centerLng = (minLng + maxLng) / 2;

      const corners = [
        [minLat, minLng],
        [minLat, maxLng],
        [maxLat, minLng],
        [maxLat, maxLng]
      ];

      const R = 6371000;
      let maxDist = 0;

      corners.forEach(([lat, lng]) => {
        const dLat = (lat - centerLat) * Math.PI / 180;
        const dLng = (lng - centerLng) * Math.PI / 180;

        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos(centerLat * Math.PI / 180) *
          Math.cos(lat * Math.PI / 180) *
          Math.sin(dLng / 2) ** 2;

        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const dist = R * c;

        if (dist > maxDist) maxDist = dist;
      });

      return maxDist;
    }

    // -----------------------------
    // DESSINER UN CERCLE
    // -----------------------------
    function drawCircle(lng, lat, radiusMeters) {

      // remove previous
      if (map.getLayer("circle-layer")) map.removeLayer("circle-layer");
      if (map.getLayer("circle-outline")) map.removeLayer("circle-outline");
      if (map.getSource("circle-source")) map.removeSource("circle-source");

      const points = 128;
      const coords = [];
      const R = 6371000;

      for (let i = 0; i < points; i++) {
        const angle = (i / points) * Math.PI * 2;

        const dx = radiusMeters * Math.cos(angle);
        const dy = radiusMeters * Math.sin(angle);

        const newLat = lat + (dy / R) * (180 / Math.PI);
        const newLng = lng + (dx / (R * Math.cos(lat * Math.PI / 180))) * (180 / Math.PI);

        coords.push([newLng, newLat]);
      }

      coords.push(coords[0]);

      map.addSource("circle-source", {
        type: "geojson",
        data: {
          type: "Feature",
          geometry: {
            type: "Polygon",
            coordinates: [coords]
          }
        }
      });

      map.addLayer({
        id: "circle-layer",
        type: "fill",
        source: "circle-source",
        paint: {
          "fill-color": "#7d7bff",
          "fill-opacity": 0.18
        }
      });

      map.addLayer({
        id: "circle-outline",
        type: "line",
        source: "circle-source",
        paint: {
          "line-color": "#574bff",
          "line-width": 2,
          "line-dasharray": [2, 2]
        }
      });
    }

    // -----------------------------
    // INIT MAP
    // -----------------------------
    function initMap() {
      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v12",
        center: [2.5, 47],
        zoom: 5
      });

      // Fix responsive
      setTimeout(() => map.resize(), 300);
      window.addEventListener("resize", () => map.resize());

      // Quand la map a fini de charger
      map.on("load", () => {
        console.log("üü¢ Mapbox LOAD OK");

        console.log("üìÑ Liste des layers :", map.getStyle().layers);

        try {
          map.setPaintProperty("poi-label", "text-color", "#333");
          map.setLayoutProperty("poi-label", "text-size", 14);

          map.setPaintProperty("transit-label", "text-color", "#000");
          map.setLayoutProperty("transit-label", "text-size", 14);
        } catch (e) {
          console.warn("‚ö†Ô∏è Impossible d‚Äôajuster les propri√©t√©s des POI :", e);
        }

        map.on("zoom", () => {
          const z = map.getZoom();
          console.log("üîé Zoom =", z);

          try {
            map.setLayoutProperty(
              "poi-label",
              "visibility",
              z >= 12 ? "visible" : "none"
            );
          } catch (e) {
            console.warn("‚ö†Ô∏è POI layer introuvable :", e);
          }

          try {
            const transitLayers = [
              "transit-label",
              "transit-labels",
              "rail-label",
              "railway-label",
              "subway-label",
              "bus-label",
              "train-label"
            ];

            transitLayers.forEach(id => {
              if (map.getLayer(id)) {
                map.setLayoutProperty(id, "visibility", z >= 12 ? "visible" : "none");
              }
            });
          } catch (e) {
            console.warn("‚ö†Ô∏è Transit layer introuvable :", e);
          }
        });
      });
    }

    // -----------------------------
    // RENDER MARKERS
    // -----------------------------
    function renderHabitats(habitats) {

      // Clear anciens markers
      Object.values(markersById).forEach(m => m.remove());
      markersById = {};

      habitats.forEach(h => {

        // couleur
        let color = "#3C33C3";
        if (h.status === "A Venir") color = "#FF8657";
        if (h.colorBox) color = h.colorBox;

        // marker
        const el = document.createElement("div");
        el.className = "marker";
        el.style.setProperty("--color", color);

        // popup
        const popupContent = `
          <div class="popup-link-wrapper" data-habitat-id="${h.id}">
            <div class="popup-card">
              ${h.image ? `<img src="${h.image}" class="popup-image" />` : ""}

              <div class="popup-body">
                <div class="popup-title">${h.title}</div>

                <div class="popup-address">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  <span>${h.adresseLabel || h.city || ""}</span>
                </div>

                <div class="popup-separator"></div>

                <div class="popup-coloc">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                    width="18" height="18">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
                  </svg>
                  <span>${h.shortDescription || ""}</span>
                </div>

                <div class="popup-footer">
                  <div class="popup-status"
                       style="background:${h.status === 'Ouvert' ? '#3C33C3' : '#FF8657'}; color:white;">
                    ${h.status === "Ouvert" ? "Ouvert" : "√Ä venir"}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        const popup = new mapboxgl.Popup({ offset: 12 }).setHTML(popupContent);

        const marker = new mapboxgl.Marker(el)
          .setLngLat([h.lng, h.lat])
          .setPopup(popup)
          .addTo(map);

        // clic marker ‚Üí notifier Wix (ouvre la fiche √† droite)
        el.addEventListener("click", () => {
          if (openPopup && openPopup !== popup) openPopup.remove();

          popup.addTo(map);
          openPopup = popup;

          parent.postMessage(
            {
              type: "OPEN_HABITAT",
              habitatId: h.id,
              slug: h.slug
            },
            "*"
          );
        });

        // clic sur la popup ‚Üí m√™me comportement (mais pas de navigation directe)
        popup.on("open", () => {
          const wrapper = document.querySelector(
            '.popup-link-wrapper[data-habitat-id="' + h.id + '"]'
          );
          if (!wrapper) return;

          wrapper.addEventListener("click", (e) => {
            e.preventDefault();
            parent.postMessage(
              {
                type: "OPEN_HABITAT_PAGE",
                slug: h.slug
              },
              "*"
            );
          });
        });

        markersById[h.id] = marker;
      });
    }

    // -----------------------------
    // FOCUS HABITAT
    // -----------------------------
    function focusHabitat(habitatId) {
      const marker = markersById[habitatId];
      if (!marker) return;

      const pos = marker.getLngLat();

      map.flyTo({
        center: pos,
        zoom: 13,
        speed: 0.8
      });

      const popup = marker.getPopup();

      if (openPopup && openPopup !== popup) openPopup.remove();

      popup.addTo(map);
      openPopup = popup;
    }

    // -----------------------------
    // CENTRER SUR L‚ÄôADRESSE SAISIE
    // -----------------------------
    function centerOnUser(lat, lng) {
      map.flyTo({
        center: [lng, lat],
        zoom: 10,
        speed: 0.8
      });
    }

    // -----------------------------
    // MESSAGE RE√áUS DE WIX
    // -----------------------------
    window.addEventListener("message", (event) => {
      const { type, habitats, habitatId, userLat, userLng,
              minLat, minLng, maxLat, maxLng } = event.data || {};

      if (type === "INIT_HABITATS") {
        renderHabitats(habitats);
      }

      if (type === "SET_VIEW") {
        map.flyTo({
          center: event.data.center,
          zoom: event.data.zoom,
          speed: 0.6
        });
      }

      if (type === "FOCUS_HABITAT") {
        focusHabitat(habitatId);
      }

      if (type === "CENTER_ON_USER") {
        centerOnUser(userLat, userLng);
      }

      // adapter la vue + cercle sur r√©gion (Tous / IDF / Bordeaux)
      if (type === "FIT_BOUNDS" && map && minLat != null) {

        const centerLat = (minLat + maxLat) / 2;
        const centerLng = (minLng + maxLng) / 2;

        const ZOOM = 9;

        map.flyTo({
          center: [centerLng, centerLat],
          zoom: ZOOM,
          speed: 0.8
        });

        const radius = computeRadiusFromBounds(minLat, minLng, maxLat, maxLng);

        drawCircle(centerLng, centerLat, radius);
      }
    });

    initMap();
  </script>
</body>
</html>
