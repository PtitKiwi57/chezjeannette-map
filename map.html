<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.1">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta charset="UTF-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>body, html { margin:0; padding:0; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>#map { width:100%; height:100%; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>.marker-popup {</p>
<p class="p1"><span class="Apple-converted-space">      </span>padding: 8px 10px;</p>
<p class="p1"><span class="Apple-converted-space">      </span>font-family: system-ui, sans-serif;</p>
<p class="p1"><span class="Apple-converted-space">      </span>font-size: 13px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.marker-title { font-weight:bold; margin-bottom:4px; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>.marker-city { font-size:12px; opacity:0.8; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="map"&gt;&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>mapboxgl.accessToken = "pk.eyJ1IjoicHRpdGtpd2kiLCJhIjoiY21pZG9uZGkwMDZ4MzJpcXZ0dnVoM2YwNSJ9.AbdFkhkiESdeKA7XNTUQNQ";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>let map;</p>
<p class="p1"><span class="Apple-converted-space">    </span>let markersById = {};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function initMap() {</p>
<p class="p1"><span class="Apple-converted-space">      </span>map = new mapboxgl.Map({</p>
<p class="p1"><span class="Apple-converted-space">        </span>container: "map",</p>
<p class="p1"><span class="Apple-converted-space">        </span>style: "mapbox://styles/mapbox/light-v11",</p>
<p class="p1"><span class="Apple-converted-space">        </span>center: [2.5, 47], // centre France</p>
<p class="p1"><span class="Apple-converted-space">        </span>zoom: 5</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function renderHabitats(habitats) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Clean markers</p>
<p class="p1"><span class="Apple-converted-space">      </span>Object.values(markersById).forEach(m =&gt; m.remove());</p>
<p class="p1"><span class="Apple-converted-space">      </span>markersById = {};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>habitats.forEach(h =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const el = document.createElement("div");</p>
<p class="p1"><span class="Apple-converted-space">        </span>el.className = "marker";</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const popupContent = `</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;div class="marker-popup"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="marker-title"&gt;${h.title}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div class="marker-city"&gt;${h.city || ""}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div&gt;${h.shortDescription || ""}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const popup = new mapboxgl.Popup({ offset: 15 }).setHTML(popupContent);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const marker = new mapboxgl.Marker(el)</p>
<p class="p1"><span class="Apple-converted-space">          </span>.setLngLat([h.lng, h.lat])</p>
<p class="p1"><span class="Apple-converted-space">          </span>.setPopup(popup)</p>
<p class="p1"><span class="Apple-converted-space">          </span>.addTo(map);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>el.addEventListener("click", () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>parent.postMessage({ type: "OPEN_HABITAT", habitatId: h.id }, "*");</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>markersById[h.id] = marker;</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Ajuste le zoom sur tous les points</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (habitats.length) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const bounds = new mapboxgl.LngLatBounds();</p>
<p class="p1"><span class="Apple-converted-space">        </span>habitats.forEach(h =&gt; bounds.extend([h.lng, h.lat]));</p>
<p class="p1"><span class="Apple-converted-space">        </span>map.fitBounds(bounds, { padding: 50 });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>function focusHabitat(habitatId) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const marker = markersById[habitatId];</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (marker) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const lngLat = marker.getLngLat();</p>
<p class="p1"><span class="Apple-converted-space">        </span>map.flyTo({ center: lngLat, zoom: 13 });</p>
<p class="p1"><span class="Apple-converted-space">        </span>marker.togglePopup();</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>window.addEventListener("message", (event) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const { type, habitats, habitatId } = event.data || {};</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (type === "INIT_HABITATS") {</p>
<p class="p1"><span class="Apple-converted-space">        </span>renderHabitats(habitats || []);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (type === "FOCUS_HABITAT") {</p>
<p class="p1"><span class="Apple-converted-space">        </span>focusHabitat(habitatId);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>initMap();</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
