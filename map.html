<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />

  <!-- MAPBOX -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      overflow: hidden;
    }

    /* La carte prend tout lâ€™espace */
    #map {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 700px;
      background: #eee;
    }

    /* MARKER SIMPLE & STABLE (rien dâ€™autre !) */
    .marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color);
      border: 3px solid white;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      cursor: pointer;
    }

    /* Popup simple */
    .mapboxgl-popup-content {
      font-family: system-ui, sans-serif;
      padding: 12px 14px;
      border-radius: 8px;
      font-size: 13px;
      background: white;
      color: #333;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    console.log("ðŸ“ map.html loaded");

    mapboxgl.accessToken = "pk.eyJ1IjoicHRpdGtpd2kiLCJhIjoiY21pZG9uZGkwMDZ4MzJpcXZ0dnVoM2YwNSJ9.AbdFkhkiESdeKA7XNTUQNQ";

    let map = null;
    let markersById = {};
    let openPopup = null; // un seul popup Ã  la fois

    // -----------------------------
    // INIT MAP
    // -----------------------------
    function initMap() {
      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [2.5, 47],
        zoom: 5,
      });

      setTimeout(() => map.resize(), 300);
      window.addEventListener("resize", () => map.resize());
    }


    // -----------------------------
    // RENDER MARKERS
    // -----------------------------
    function renderHabitats(habitats) {

      // nettoyer anciens markers
      Object.values(markersById).forEach(m => m.remove());
      markersById = {};

      habitats.forEach(h => {

        // Choix de couleur
        let color = "#6B4EFF"; // violet
        if (h.status === "A Venir") color = "#FFA027"; // orange
        if (h.colorBox) color = h.colorBox; // surcharge depuis DB

        // Ã‰lÃ©ment marker
        const el = document.createElement("div");
        el.className = "marker";
        el.style.setProperty("--color", color);

        // Popup
        const popupContent = `
          <div>
            <div style="font-weight:bold; margin-bottom:4px;">${h.title}</div>
            <div style="opacity:0.7; margin-bottom:4px;">${h.city || ""}</div>
            <div>${h.shortDescription || ""}</div>
          </div>
        `;

        const popup = new mapboxgl.Popup({ offset: 12 }).setHTML(popupContent);

        // Marker sur la carte
        const marker = new mapboxgl.Marker(el)
          .setLngLat([h.lng, h.lat])
          .setPopup(popup)
          .addTo(map);

        // Clic marker
        el.addEventListener("click", () => {

          // fermer popup prÃ©cÃ©dent
          if (openPopup && openPopup !== popup) openPopup.remove();

          popup.addTo(map);
          openPopup = popup;

          // envoyer message Ã  Wix
          parent.postMessage({
            type: "OPEN_HABITAT",
            habitatId: h.id,
            slug: h.slug
          }, "*");
        });

        markersById[h.id] = marker;
      });
    }


    // -----------------------------
    // FOCUS SUR UN MARKER
    // -----------------------------
    function focusHabitat(habitatId) {
      const marker = markersById[habitatId];
      if (!marker) return;

      const pos = marker.getLngLat();

      map.flyTo({
        center: pos,
        zoom: 13,
        speed: 0.8
      });

      let popup = marker.getPopup();

      if (openPopup && openPopup !== popup) openPopup.remove();

      popup.addTo(map);
      openPopup = popup;
    }


    // -----------------------------
    // LISTENER MESSAGE WIX â†’ MAP
    // -----------------------------
    window.addEventListener("message", (event) => {
      const { type, habitats, habitatId } = event.data || {};

      if (type === "INIT_HABITATS") renderHabitats(habitats);
      if (type === "FOCUS_HABITAT") focusHabitat(habitatId);
    });


    // Lancement
    initMap();
  </script>
</body>
</html>
