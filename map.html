<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />

  <!-- MAPBOX -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      display: flex;
      overflow: hidden;
    }

    #map {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 700px;
      background: #eee;
    }

    /* Marker simple */
    .marker {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--color);
      border: 3px solid white;
      box-shadow: 0 0 6px rgba(0,0,0,0.25);
      cursor: pointer;
    }

    .mapboxgl-popup {
  max-width: 280px !important;
}

.mapboxgl-popup-content {
  padding: 0;
  border-radius: 18px;
  overflow: hidden;
  font-family: system-ui, sans-serif;
}

.popup-card {
  background: white;
}

.popup-image {
  width: 100%;
  height: 150px;
  object-fit: cover;
  display: block;
}

.popup-body {
  padding: 14px 16px 16px;
}

.popup-title {
  font-size: 18px;
  font-weight: 600;
  color: #2f2cd6;
  margin-bottom: 8px;
}

.popup-address {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  font-size: 13px;
  color: #555;
  margin-bottom: 10px;
}

.popup-address span {
  line-height: 1.3;
}

.popup-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.popup-status {
  background: #2f2cd6;
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
}

.popup-pin {
  width: 36px;
  height: 36px;
  background: #2f2cd6;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    console.log("ðŸ“ map.html loaded");

    mapboxgl.accessToken =
      "pk.eyJ1IjoicHRpdGtpd2kiLCJhIjoiY21pZG9uZGkwMDZ4MzJpcXZ0dnVoM2YwNSJ9.AbdFkhkiESdeKA7XNTUQNQ";

    let map = null;
    let markersById = {};
    let openPopup = null;

    // -----------------------------
    // INIT MAP
    // -----------------------------
    function initMap() {
      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/light-v11",
        center: [2.5, 47],
        zoom: 5
      });

      // Fix responsive
      setTimeout(() => map.resize(), 300);
      window.addEventListener("resize", () => map.resize());
    }

    // -----------------------------
    // RENDER MARKERS
    // -----------------------------
    function renderHabitats(habitats) {

      // Clear anciens markers
      Object.values(markersById).forEach(m => m.remove());
      markersById = {};

      habitats.forEach(h => {

        // ðŸ‘‡ couleur
        let color = "#6B4EFF";
        if (h.status === "A Venir") color = "#FFA027";
        if (h.colorBox) color = h.colorBox;

        // marker
        const el = document.createElement("div");
        el.className = "marker";
        el.style.setProperty("--color", color);

        // popup
        const popupContent = `
  <div class="popup-card">
    ${
      h.image
        ? `<img src="${h.image}" class="popup-image" />`
        : ""
    }

    <div class="popup-body">
      <div class="popup-title">${h.title}</div>

      <div class="popup-address">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <path d="M12 22s8-7.58 8-13a8 8 0 1 0-16 0c0 5.42 8 13 8 13z" fill="#2f2cd6"/>
          <circle cx="12" cy="9" r="3" fill="white"/>
        </svg>
        <span>${h.adresseLabel || h.city || ""}</span>
      </div>

      <div class="popup-footer">
        <div class="popup-status">
          ${h.status === "Ouvert" ? "Ouvert" : "Ã€ venir"}
        </div>

        <div class="popup-pin">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="white">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
`;

        const popup = new mapboxgl.Popup({ offset: 12 }).setHTML(popupContent);

        const marker = new mapboxgl.Marker(el)
          .setLngLat([h.lng, h.lat])
          .setPopup(popup)
          .addTo(map);

        // clic marker â†’ notifier Wix
        el.addEventListener("click", () => {

          if (openPopup && openPopup !== popup) openPopup.remove();

          popup.addTo(map);
          openPopup = popup;

          parent.postMessage(
            {
              type: "OPEN_HABITAT",
              habitatId: h.id,
              slug: h.slug
            },
            "*"
          );
        });

        markersById[h.id] = marker;
      });
    }

    // -----------------------------
    // FOCUS HABITAT
    // -----------------------------
    function focusHabitat(habitatId) {
      const marker = markersById[habitatId];
      if (!marker) return;

      const pos = marker.getLngLat();

      map.flyTo({
        center: pos,
        zoom: 13,
        speed: 0.8
      });

      const popup = marker.getPopup();

      if (openPopup && openPopup !== popup) openPopup.remove();

      popup.addTo(map);
      openPopup = popup;
    }

    // -----------------------------
    // NEW : CENTRER SUR Lâ€™ADRESSE SAISIE
    // -----------------------------
    function centerOnUser(lat, lng) {
      map.flyTo({
        center: [lng, lat],
        zoom: 10,
        speed: 0.8
      });
    }

    // -----------------------------
    // MESSAGE REÃ‡US DE WIX
    // -----------------------------
    window.addEventListener("message", (event) => {
      const { type, habitats, habitatId, userLat, userLng } = event.data || {};

      if (type === "INIT_HABITATS") {
        renderHabitats(habitats);
      }

      if (type === "FOCUS_HABITAT") {
        focusHabitat(habitatId);
      }

      if (type === "CENTER_ON_USER") {
        centerOnUser(userLat, userLng);
      }
    });

    initMap();
  </script>
</body>
</html>
